#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
EXTERNAL_DIR="${EXTERNAL_DIR:-$ROOT_DIR/external}"
LOCK_FILE="${LOCK_FILE:-$EXTERNAL_DIR/versions.lock}"

PYDS_REPO_URL="${PYDS_REPO_URL:-https://github.com/reineking/pyds.git}"
DST_PY_REPO_URL="${DST_PY_REPO_URL:-https://github.com/geekabel/dst-py.git}"
DSTZ_REPO_URL="${DSTZ_REPO_URL:-https://github.com/ztxtech/dstz.git}"

PYDS_DEFAULT_REF="${PYDS_DEFAULT_REF:-master}"
DST_PY_DEFAULT_REF="${DST_PY_DEFAULT_REF:-main}"
DSTZ_DEFAULT_REF="${DSTZ_DEFAULT_REF:-main}"

# Usage:
#   bash scripts/vendor/fetch_external_libs.sh
#       - If lock exists: install exact pinned versions from lock.
#       - If lock is missing: bootstrap from default refs and write lock.
#   bash scripts/vendor/fetch_external_libs.sh --update-lock
#       - refresh repos from default refs and rewrite lock with current SHAs.

UPDATE_LOCK=0
if [[ "${1:-}" == "--update-lock" ]]; then
  UPDATE_LOCK=1
fi

mkdir -p "$EXTERNAL_DIR"

declare -A REPOS=(
  [py_dempster_shafer]="$PYDS_REPO_URL"
  [dst-py]="$DST_PY_REPO_URL"
  [dstz]="$DSTZ_REPO_URL"
)

declare -A DEFAULT_REFS=(
  [py_dempster_shafer]="$PYDS_DEFAULT_REF"
  [dst-py]="$DST_PY_DEFAULT_REF"
  [dstz]="$DSTZ_DEFAULT_REF"
)

declare -A LOCKED_REFS

load_lock() {
  local lock_path="$1"
  [[ -f "$lock_path" ]] || return 1

  while IFS='=' read -r name ref; do
    [[ -z "${name// }" ]] && continue
    [[ "$name" =~ ^# ]] && continue
    name="$(echo "$name" | xargs)"
    ref="$(echo "$ref" | xargs)"
    if [[ -n "$name" && -n "$ref" ]]; then
      LOCKED_REFS["$name"]="$ref"
    fi
  done < "$lock_path"

  return 0
}

clone_or_update() {
  local name="$1"
  local repo_url="$2"
  local target_dir="$3"
  local ref="$4"

  if [[ -d "$target_dir/.git" ]]; then
    echo "[vendor] Updating $name"
    git -C "$target_dir" fetch --tags --prune
  else
    echo "[vendor] Cloning $name from $repo_url"
    git clone "$repo_url" "$target_dir"
  fi

  echo "[vendor] Checkout $ref in $name"

  if [[ "$ref" =~ ^[0-9a-fA-F]{40}$ ]]; then
    git -C "$target_dir" checkout "$ref"
    return
  fi

  if git -C "$target_dir" show-ref --verify --quiet "refs/remotes/origin/$ref"; then
    git -C "$target_dir" checkout -B "$ref" "origin/$ref"
  else
    git -C "$target_dir" checkout "$ref"
  fi
}

resolve_ref() {
  local name="$1"

  if [[ "$UPDATE_LOCK" -eq 0 && -n "${LOCKED_REFS[$name]:-}" ]]; then
    echo "${LOCKED_REFS[$name]}"
  else
    echo "${DEFAULT_REFS[$name]}"
  fi
}

write_lock() {
  local lock_path="$1"
  local tmp="${lock_path}.tmp"

  {
    echo "# Auto-generated by scripts/vendor/fetch_external_libs.sh"
    echo "# Run with --update-lock to refresh pinned SHAs."
    for name in py_dempster_shafer dst-py dstz; do
      local target_dir="$EXTERNAL_DIR/$name"
      local sha
      sha="$(git -C "$target_dir" rev-parse HEAD)"
      echo "$name=$sha"
    done
  } > "$tmp"

  mv "$tmp" "$lock_path"
  echo "[vendor] Wrote lock file: $lock_path"
}

if load_lock "$LOCK_FILE"; then
  echo "[vendor] Using pinned versions from: $LOCK_FILE"
else
  echo "[vendor] Lock file not found: $LOCK_FILE"
  echo "[vendor] Bootstrapping from default refs and creating lock"
fi

for name in py_dempster_shafer dst-py dstz; do
  repo_url="${REPOS[$name]}"
  target_dir="$EXTERNAL_DIR/$name"
  ref="$(resolve_ref "$name")"
  clone_or_update "$name" "$repo_url" "$target_dir" "$ref"
done

write_lock "$LOCK_FILE"

echo "[vendor] Done. Installed repositories under: $EXTERNAL_DIR"
